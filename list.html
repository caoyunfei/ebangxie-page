<!DOCTYPE html>
<html>
<head>
<meta charset=UTF-8>
<meta content="IE=edge,chrome=1" http-equiv=X-UA-Compatible>
<meta content=320 name=MobileOptimized>
<meta content=yes name=apple-mobile-web-app-capable>
<meta content=black name=apple-mobile-web-app-status-bar-style>
<meta name=format-detection content="telephone=no">
<meta name=viewport content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta http-equiv="content-type" content="text/html;charset=UTF-8">
<meta name=description content=e帮鞋>
<meta name=keywords content=e帮鞋>
<title>e帮鞋-选择</title>
<link rel="shortcut icon" href=images/logo_50_50png.png>
<link rel=stylesheet href=css/style.css>
<link rel=stylesheet href=css/list.css>
<link rel=stylesheet href=css/zepto.dialog.css>
</head>
<body>
<div class="wrap">
<header id="header" class="bg"><div class="city"><a target="_self" href="index.html"><h6>< 返回</h6></a></div>光面</header>
<ul class="nav">
<li data-index=0 style="width:25%;"><div>光面</div><span>0</span></li>
<li data-index=1 style="width:25%;border-right:1px #ccc solid;"><div>非光面</div><span>0</span></li>
<li data-index=2 style="width:50%;"><div>修鞋</div><span>0</span></li>
</ul>
<div id="wrapper">
<div id="scroller">
<div class="list">
<ul style="display:block">
    <li>
        <div class="left">
            <img src="images/4.webp" alt="低帮（脚踝以下）" width="76" width="96" onerror="this.src='images/l4.jpg'">
        </div>
        <div class="right">
            <p>低帮（脚踝以下）</p>
            <dl>
                <dt>
                    <p>帮帮价:
                        <span class="red">￥</span>
                        <span class="red spanType1">20</span>
                    </p>
                    <p>
                        <span class="spanType3">市场价￥28</span>
                    </p>
                </dt>
                <dd>
                    <div class="add-sub">
                        <div class="sub"></div>
                        <div class="text">0</div>
                        <div class="add" data-index=0 data-subtype=0></div>
                    </div>
                </dd>
            </dl>
        </div>
    </li>
    <li>
        <div class="left">
            <img src="images/5.webp" alt="高帮（膝盖以下）" width= width="76" width="96" onerror="this.src='images/l5.jpg'">
        </div>
        <div class="right">
            <p>高帮（膝盖以下）</p>
            <dl>
                <dt>
                    <p>帮帮价:
                        <span class="red">￥</span>
                        <span class="red spanType1">30</span>
                    </p>
                    <p>
                        <span class="spanType3">市场价￥40</span>
                    </p>
                </dt>
                <dd>
                    <div class="add-sub">
                        <div class="sub"></div>
                        <div class="text">0</div>
                        <div class="add" data-index=0 data-subtype=1></div>
                    </div>
                </dd>
            </dl>
        </div>
    </li>
    <li>
        <div class="left">
            <img src="images/6.webp" alt="过膝（膝盖以上）" width="76" width="96" onerror="this.src='images/l6.jpg'">
        </div>
        <div class="right">
            <p>过膝（膝盖以上）</p>
            <dl>
                <dt>
                    <p>帮帮价:
                        <span class="red">￥</span>
                        <span class="red spanType1">40</span>
                    </p>
                    <p>
                        <span class="spanType3">市场价￥100</span>
                    </p>
                </dt>
                <dd>
                    <div class="add-sub">
                        <div class="sub"></div>
                        <div class="text">0</div>
                        <div class="add" data-index=0 data-subtype=2></div>
                    </div>
                </dd>
            </dl>
        </div>
    </li>
</ul>
<ul>
       <li>
        <div class="left">
            <img src="images/1.webp" alt="低帮（脚踝以下）" width="76" width="96" onerror="this.src='images/l1.jpg'">
        </div>
        <div class="right">
            <p>低帮（脚踝以下）</p>
            <dl>
                <dt>
                    <p>帮帮价:
                        <span class="red">￥</span>
                        <span class="red spanType1">30</span>
                    </p>
                    <p>
                        <span class="spanType3">市场价￥40</span>
                    </p>
                </dt>
                <dd>
                    <div class="add-sub">
                        <div class="sub"></div>
                        <div class="text">0</div>
                        <div class="add" data-index=1 data-subtype=0></div>
                    </div>
                </dd>
            </dl>
        </div>
    </li>
    <li>
        <div class="left">
            <img src="images/2.webp" alt="高帮（膝盖以下）" width="76" width="96" onerror="this.src='images/l2.jpg'">
        </div>
        <div class="right">
            <p>高帮（膝盖以下）</p>
            <dl>
                <dt>
                    <p>帮帮价:
                        <span class="red">￥</span>
                        <span class="red spanType1">40</span>
                    </p>
                    <p>
                        <span class="spanType3">市场价￥60</span>
                    </p>
                </dt>
                <dd>
                    <div class="add-sub">
                        <div class="sub"></div>
                        <div class="text">0</div>
                        <div class="add" data-index=1 data-subtype=1></div>
                    </div>
                </dd>
            </dl>
        </div>
    </li>
    <li>
        <div class="left">
            <img src="images/3.webp" alt="过膝（膝盖以上）" width="76" width="96" onerror="this.src='images/l3.jpg'">
        </div>
        <div class="right">
            <p>过膝（膝盖以上）</p>
            <dl>
                <dt>
                    <p>帮帮价:
                        <span class="red">￥</span>
                        <span class="red spanType1">50</span>
                    </p>
                    <p>
                        <span class="spanType3">市场价￥120</span>
                    </p>
                </dt>
                <dd>
                    <div class="add-sub">
                        <div class="sub"></div>
                        <div class="text">0</div>
                        <div class="add" data-index=1 data-subtype=2></div>
                    </div>
                </dd>
            </dl>
        </div>
    </li>
</ul>
<ul>
    <li>
        <div class="left">
            <img src="images/8.webp" alt="加前掌" width="76" width="96" onerror="this.src='images/l8.jpg'">
        </div>
        <div class="right">
            <p>加前掌</p>
            <dl>
                <dt>
                    <p>帮帮价:
                        <span class="red">￥</span>
                        <span class="red spanType1">80</span>
                    </p>
                    <p>
                        <span class="spanType3">市场价￥120</span>
                    </p>
                </dt>
                <dd>
                    <div class="add-sub">
                        <div class="sub"></div>
                        <div class="text">0</div>
                        <div class="add" data-index=2 data-subtype=0></div>
                    </div>
                </dd>
            </dl>
        </div>
    </li>
    <li>
        <div class="left">
            <img src="images/7.webp" alt="加后掌" width="76" width="96" onerror="this.src='images/l7.jpg'">
        </div>
        <div class="right">
            <p>加后掌</p>
            <dl>
                <dt>
                    <p>帮帮价:
                        <span class="red">￥</span>
                        <span class="red spanType1">80</span>
                    </p>
                    <p>
                        <span class="spanType3">市场价￥150</span>
                    </p>
                </dt>
                <dd>
                    <div class="add-sub">
                        <div class="sub"></div>
                        <div class="text">0</div>
                        <div class="add" data-index=2 data-subtype=1></div>
                    </div>
                </dd>
            </dl>
        </div>
    </li>
    <li>
        <div class="left">
            <img src="images/9.webp" alt="补色、翻新" width="76" width="96" onerror="this.src='images/l9.jpg'">
        </div>
        <div class="right">
            <p>补色、翻新</p>
            <dl>
                <dt>
                    <p>帮帮价:
                        <span class="red">￥</span>
                        <span class="red spanType1">130</span>
                    </p>
                    <p>
                        <span class="spanType3">市场价￥180</span>
                    </p>
                </dt>
                <dd>
                    <div class="add-sub">
                        <div class="sub"></div>
                        <div class="text">0</div>
                        <div class="add" data-index=2 data-subtype=2></div>
                    </div>
                </dd>
            </dl>
        </div>
    </li>
</ul>
</div></div></div>
<footer id="footer"  class="footerbg">
    <nav>   
      <a target=_self href=index.html></a>
      <a target=_self href=order.html><span style="display:none;">0</span></a>
      <a target=_self href=my.html></a>
    </nav>
</footer>
</div>
<script src="js/zepto.min.js"></script>
<script src="js/iscroll.js" defer></script>
<script src="js/zepto.dialog.js" defer></script>
<script>
$(function(){
var myScroll = new IScroll('#wrapper',{bounceEasing:'elastic',bounceTime:1200,fadeScrollbars:false,scrollbars:false,preventDefault:false}),
    hash = window.location.hash,
    navLi = $(".nav li"),
    listUl = $(".list ul"),
    hash = hash.substring(1,hash.length),
    header = $("#header"),
    eventType = "click",
    navA = $('a[href="order.html"]'),
    navSpan = navA.find("span"),
    data = JSON.parse(localStorage.getItem("data")),
    i = len = 0,
    orderList = order = addClass = lu = iii =null,
    TYPE_GW = 0,TYPE_FM = 1,TYPE_XX = 2;//光面0，非光面（翻毛磨砂）1，洗修2
//在进入选择页面之后，首先访问本地存储，看看有没有值，若有值
//就把值取出来，赋值到 tab、footer、text上  无bug
if(data && data.clickCount){
  navSpan.addClass("tips");
  navA.addClass("hasOrder");
  navSpan.html(data.clickCount);
  orderList = data.orderList;
  for(len = orderList.length;i<len;i++){
     order = orderList[i];
     addClass = $(navLi[order.type]).find("span");
     if(order.count){
        addClass.addClass("tips");
        navA.addClass("hasOrder");
        addClass.html(order.count);
        lu = $(listUl[order.type]);
        iii = $(lu.find(".add")[order.subtype]).prev();
        if(order.curValue){
            iii[0].style.visibility="visible";
            iii[0].innerHTML = order.curValue; 
            iii.prev()[0].style.visibility="visible";
        }
     }
  }
}
//若没有任何订单则footer中的去往订单导航不可用
navA.on("click",function(){
  //判断footer中的数值是否大于0
  if(!+navSpan.html()){
  // if(!data || !data.clickCount){//这样判断的话会有bug，当页面的dom发生了变化，但其实本地存储还没有更新，要刷新一下，但是刷新的话用户体验不好。。所以换一种判断方式。
    $.dialog({
            content : '鞋篮还是空的哦~',
            okText: '好',
            ok:function(){}
    });
    return false;
  }
});
/**
*是否刷新？默认为false
*显示当前的条目、切换顶部tab、改变header中的text
*无bug
*/         
function tab(hash,isRefresh){
    isRefresh = isRefresh || false;
    hash = +hash || TYPE_GW;
    if(hash === 2){
        navLi.removeClass("selct-xiu");
        $(navLi[hash]).addClass("selct-xiu");
        navLi.removeClass("selct");
    }else{
        navLi.removeClass("selct");
        $(navLi[hash]).addClass("selct");
         navLi.removeClass("selct-xiu");
    }

    listUl.css("display","none");
    listUl[hash].style.display="block";
    var html = "<div class='city'><a target='_self' href='index.html'><h6>< 返回</h6></a></div>";
    switch(hash){
        case TYPE_FM:header.html(html+"洗-非光面");break;
        case TYPE_XX:header.html(html+"修鞋");break;
        default:header.html(html+"洗-光面");
    }
    isRefresh && myScroll.refresh();
}
tab(hash);
navLi.on('touchstart',function(e){
    $(this).off("click");
    var target = e.target;
    if(target === this){
        hash = target.dataset.index; 
    }else{
        hash = e.target.parentNode.dataset.index;
    }
    tab(hash,true);
});
navLi.on('click',function(e){
    var target = e.target;
    if(target === this){
        hash = target.dataset.index; 
    }else{
        hash = e.target.parentNode.dataset.index;
    }
    tab(hash,true);
});
//交互2：点击 + 号，改变dom
listUl.find(".add").each(function() {
    var
        _this = $(this),
        text = _this.prev(),
        index = this.dataset.index,
        subtype = this.dataset.subtype,
        sub = text.prev(),
        navLiSpan = $($(".nav li span")[index]);
     _this.on('touchstart',function(){
        _this.off("click");
        var curValue = text.text(),
            clickCount = $('a[href="order.html"] span').text(),
            count = navLiSpan.text();
        clickCount++;
        curValue++;
        count++;
        text.css("visibility","visible");
        sub.css("visibility","visible");
        text.html(curValue);
        navLiSpan.addClass("tips");
        navSpan.addClass("tips");
        navA.addClass("hasOrder");
        navLiSpan.html(count);
        navSpan.html(clickCount);
        save(index,count,subtype,curValue);
    });
    _this.on('click',function(){
        var curValue = text.text(),
            clickCount = $('a[href="order.html"] span').text(),
            count = navLiSpan.text();
        clickCount++;
        curValue++;
        count++;
        text.css("visibility","visible");
        sub.css("visibility","visible");
        text.html(curValue);
        navLiSpan.addClass("tips");
        navSpan.addClass("tips");
        navA.addClass("hasOrder");
        navLiSpan.html(count);
        navSpan.html(clickCount);
        save(index,count,subtype,curValue);
    });

})
//交互3：点击 - 号，改变dom
listUl.find(".sub").each(function() {
var 
    _this = $(this),
    text = _this.next(),
    index = text.next()[0].dataset.index,
    subtype = text.next()[0].dataset.subtype,
    navLiSpan = $($(".nav li span")[index]);
 _this.on('touchstart',function(){
    _this.off("click");
    var curValue = _this.next().text(),
        clickCount = $('a[href="order.html"] span').text(),
        count = navLiSpan.text();
    curValue--;
    count--;
    clickCount--;
    if(!curValue){
        text.css("visibility","hidden");
        _this.css("visibility","hidden");
    }else{
        text.css("visibility","visible");
        _this.css("visibility","visible");
    }
    text.html(curValue);
    if(!count){
       navLiSpan.removeClass("tips");
    }else{
       navLiSpan.addClass("tips");
    }
    navLiSpan.html(count);
    if(!clickCount){
       navSpan.removeClass("tips");
       navA.removeClass("hasOrder");
    }else{
       navSpan.addClass("tips"); 
       navA.addClass("hasOrder");
    }
    navSpan.html(clickCount);
    save(index,count,subtype,curValue);
});
_this.on('click',function(){
    var curValue = _this.next().text(),
        clickCount = $('a[href="order.html"] span').text(),
        count = navLiSpan.text();
    curValue--;
    count--;
    clickCount--;
    if(!curValue){
        text.css("visibility","hidden");
        _this.css("visibility","hidden");
    }else{
        text.css("visibility","visible");
        _this.css("visibility","visible");
    }
    text.html(curValue);
    if(!count){
       navLiSpan.removeClass("tips");
    }else{
       navLiSpan.addClass("tips");
    }
    navLiSpan.html(count);
    if(!clickCount){
       navSpan.removeClass("tips");
       navA.removeClass("hasOrder");
    }else{
       navSpan.addClass("tips"); 
       navA.addClass("hasOrder");
    }
    navSpan.html(clickCount);
    save(index,count,subtype,curValue);
 }); 
})
function save (type,count,subtype,curValue) {
type = +type || 0;
count = +count || 0;
var 
 data = JSON.parse(localStorage.getItem("data")),
 total = allTotal = clickCount = i = len =  0,
 orderList = order = newOrder = null,
 isInOrderList = false,
 getVal = function(type,subtype){//根据不同的类型返回不同的单价
   type = +type;
   subtype = +subtype;
   if(type === 0){
       if(subtype === 0){
         return 20;
       }else if(subtype === 1){
         return 30;
       }else if(subtype === 2){
         return 40;
       }
   }else if(type === 1){
      if(subtype === 0){
         return 30;
       }else if(subtype === 1){
         return 40;
       }else if(subtype === 2){
         return 50;
       }
   }else if(type === 2){
      if(subtype === 0){
         return 80;
       }else if(subtype === 1){
         return 80;
       }else if(subtype === 2){
         return 130;
       }
   }
 },
 getTotal = function(type,subtype,curValue){ //根据不同类型的鞋子数x单价 得出同类鞋子集合的总价
   return getVal(type,subtype)*curValue;
 };
if(data){
 orderList = data.orderList; //不同类型鞋子的集合
 for(len = orderList.length;i<len;i++){ //循环结合
   order = orderList[i];
   if(order.type === type){ // 若本次要存储的存在于本地存储，则更新订单中的count、total
      order.count = count;
      if(order.subtype === subtype){
           order.curValue = curValue;
           order.total = getTotal(type,subtype,curValue);
           isInOrderList = true;
      }
   }
 }
 if(!isInOrderList){//若本次要存储的不存在，则push新订单
   newOrder = {
                "type":type,
                "subtype":subtype,
                "curValue":curValue,
                "count":count,
                "total":getTotal(type,subtype,curValue)
              };
   orderList.push(newOrder);
 }
 //循环最新的orderList,计算出总价与总数并更新到对象上
for(i = 0,len = orderList.length;i<len;i++){
  order = orderList[i];
  allTotal += order.total;
  clickCount += order.curValue;
}
data.allTotal = allTotal;
data.clickCount = clickCount;
}else{ //若没有本地存储
 total = allTotal = getTotal(type,subtype,count); //因为是第一次存储，所以总价等于集合价
 data = 
      {
        "allTotal":allTotal,
        "clickCount":1,
        "orderList":
        [
          {
            "type":type,
            "subtype":subtype,
            "curValue":curValue,
            "count":count,
            "total":total
          }
        ]
      };
}
localStorage.setItem("data",JSON.stringify(data)); //更新本地存储
}
})
</script></body></html>